# Migration guide from 3.3.2 to 3.7.0

Starting from version 3.7.0, Lamassu introduces the **KMS (Key Management Service)** as a dedicated first-class service. Previously, cryptographic engines were tightly coupled to the CA service. This new architecture provides better separation of concerns, improved scalability, and more flexible key management capabilities.

Additionally, this version introduces an **automated database migration system** that handles schema updates across all Lamassu services, eliminating the need for manual database migrations.

The following sections describe the changes that need to be made in order to successfully upgrade the Lamassu Helm chart.

## Update Helm values.yaml (aka lamassu.yaml)

### NEW services.kms

Version 3.7.0 introduces the KMS service as a standalone component. This service is now responsible for managing all cryptographic engines that were previously configured under the CA service.

The new KMS service provides:
- Centralized key management across all Lamassu services
- Better isolation and security for cryptographic operations
- Independent scaling of key management operations
- Support for multiple crypto engines (filesystem, AWS KMS, PKCS11, HashiCorp Vault, etc.)

**Configuration:**

The KMS service uses the same configuration structure for crypto engines as before, but now under the `services.kms` key:

```yaml
services:
  kms:
    image: ghcr.io/lamassuiot/lamassu-kms:3.7.0
    cryptoEngines:
      # -- Default engine ID to be used for the KMS component
      defaultEngineID: "filesystem-1"
      engines:
        - id: "filesystem-1"
          type: "filesystem"
          metadata:
            provider: "lamassu"
            location: "local"
          storage_directory: "/crypto/fs"
```

### MOVED services.ca.cryptoEngines â†’ services.kms.cryptoEngines

All cryptographic engine configurations previously defined under `services.ca.cryptoEngines` must now be moved to `services.kms.cryptoEngines`. The structure remains the same, only the location changes.

**OLD (3.3.2):**
```yaml
services:
  ca:
    image: ghcr.io/lamassuiot/lamassu-ca:3.6.1
    domains:
      - dev.lamassu.io
    monitoring:
      frequency: "* * * * *"
    cryptoEngines:
      defaultEngineID: "filesystem-1"
      engines:
        - id: "filesystem-1"
          type: "filesystem"
          metadata:
            provider: "lamassu"
            location: "local"
          storage_directory: "/crypto/fs"
        - id: "aws-kms-1"
          type: "aws_kms"
          access_key_id: XXXXXXXXXX
          secret_access_key: XXXXXXXXXX
          region: eu-west-1
          auth_method: static
```

**NEW (3.7.0):**
```yaml
services:
  ca:
    image: ghcr.io/lamassuiot/lamassu-ca:3.7.0
    domains:
      - dev.lamassu.io
    monitoring:
      frequency: "* * * * *"
  kms:
    image: ghcr.io/lamassuiot/lamassu-kms:3.7.0
    cryptoEngines:
      defaultEngineID: "filesystem-1"
      engines:
        - id: "filesystem-1"
          type: "filesystem"
          metadata:
            provider: "lamassu"
            location: "local"
          storage_directory: "/crypto/fs"
        - id: "aws-kms-1"
          type: "aws_kms"
          access_key_id: XXXXXXXXXX
          secret_access_key: XXXXXXXXXX
          region: eu-west-1
          auth_method: static
```

> [!IMPORTANT]
> The `cryptoEngines` configuration block must be completely removed from `services.ca` and added under the new `services.kms` section. All engine configurations (filesystem, AWS KMS, PKCS11, HashiCorp Vault, etc.) should be migrated as-is.

