kind: ConfigMap
apiVersion: v1
metadata:
  name: dms-manager-config
  namespace: {{.Release.Namespace}}
data:
  init.sh: |
    #!/bin/bash
    BLUE='\033[0;34m'
    GREEN='\033[0;32m'
    NOCOLOR='\033[0m'

    echo -e "${BLUE}Bundling certificates...${NOCOLOR}"
    cat /certs/downstream.crt /certs/downstream-ca.crt > /certs/bundle.pem

    echo -e "${BLUE}Extracting root (lowest hierarchy cert in bundle)...${NOCOLOR}"
    awk -v cmd='openssl x509 -noout -subject' '
    /BEGIN/{close(cmd)};{print | cmd}' < bundle.pem | tail -n 1 > /certs/root.crt
    
    echo -e "${GREEN}Certificate Root extracted!${NOCOLOR}"
    cat /certs/root.crt
  config: |
    logs:
      level: "trace"

    server:
      log_level: "debug"
      health_check: false
      listen_address: "0.0.0.0"
      port: 8085
      protocol: "http" #http | https

    publisher_event_bus:
      log_level: "debug"
      provider: amqp
      enabled: true
      amqp:
        protocol: amqp #amqp | amqps
        hostname: {{ .Values.amqp.hostname }}
        port: {{ .Values.amqp.port }}
        basic_auth:
          enabled: true
          username: {{ .Values.amqp.username }}
          password: {{ .Values.amqp.password }}
          
    storage:
      log_level: info
      provider: "postgres" #couch_db | postgres | dynamo_db
      postgres: 
        hostname: {{ .Values.postgres.hostname }}
        port: {{ .Values.postgres.port }}
        username: {{ .Values.postgres.username }}
        password: {{ .Values.postgres.password }}
    
    device_manager_client:
      log_level: debug
      auth_mode: noauth
      protocol: http
      hostname: device-manager
      port: 8085
    
    ca_client:
      log_level: debug
      auth_mode: noauth
      protocol: http
      hostname: ca
      port: 8085
    
    downstream_cert_file: /certs/downstream-ca.crt